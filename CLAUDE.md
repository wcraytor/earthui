# CLAUDE.md — earthui

Project-level instructions for Claude Code when working on this repository.

## Project Overview

**earthui** is an R CRAN package providing a Shiny-based GUI for the
[earth](https://CRAN.R-project.org/package=earth) package (Multivariate
Adaptive Regression Splines / MARS). The package lives under `pkg/`.

## Repository Layout

```
pkg/
  R/                        # Package source
    build_allowed.R         # Allowed interaction matrix builder
    detect_categoricals.R   # Automatic categorical variable detection
    earthui-package.R       # Package-level roxygen docs
    export_report.R         # render_report() — Quarto-based export
    fit_earth.R             # fit_earth() — wraps earth::earth()
    format_results.R        # Equation, summary, ANOVA, variable importance formatters
    import_data.R           # CSV/Excel import with snake_case naming
    launch.R                # launch() — starts Shiny app
    plot_results.R          # All ggplot2/plotly/base-R plot functions
  inst/
    app/
      server.R              # Shiny server (async fitting, download handlers)
      ui.R                  # Shiny UI (Bootstrap 5, MathJax, dark mode)
    quarto/
      earth_report.qmd      # Quarto report template (HTML/PDF/Word)
  tests/testthat/           # testthat tests
  man/                      # roxygen2-generated Rd files
  DESCRIPTION               # Package metadata (AGPL-3 license)
  NAMESPACE                 # Auto-generated by roxygen2
```

## Build & Test

```bash
# Install package locally
R CMD INSTALL pkg

# Run the Shiny app (port 7878)
Rscript -e 'earthui::launch()'

# Rebuild roxygen docs + NAMESPACE
Rscript -e 'roxygen2::roxygenise("pkg")'

# Run tests
Rscript -e 'testthat::test_dir("pkg/tests/testthat")'

# Full R CMD check
R CMD build pkg && R CMD check earthui_*.tar.gz
```

## Key Conventions

- **Async model fitting**: Uses `callr::r_bg()` with stdout/stderr piping and
  a 300ms polling observer. Falls back to synchronous `fit_earth()` if callr
  is unavailable.
- **Axis formatting**: `auto_digits_()` detects axis range and selects decimal
  places (range < 1 → 3 dp for lat/long; range >= 100 → 0 dp with commas).
  Slope labels scale units accordingly (`/0.001` for small-range axes,
  `/unit` for large-range).
- **LaTeX escaping**: `latex_escape_text_()` in `format_results.R` escapes
  `_`, `$`, `%`, `&`, `#` for both MathJax and PDF/LaTeX output.
- **CSS sticky headers**: Allowed Interactions matrix uses `position: sticky`
  with `var(--bs-body-bg)` for light/dark mode support.
- **PDF export**: Renders to a temp file first, then binary-copies to Shiny's
  download path. Uses base R `persp()` for 3D plots (no external dependencies).
- **roxygen2**: All exported functions have roxygen docs. Run `roxygenise()`
  after editing any `@export` or `@param` tags.
- **NAMESPACE**: Auto-generated. Never edit by hand.
- **Port**: The Shiny app runs on fixed port 7878.

## Dependencies

- **Imports** (required): earth, ggplot2, readxl, shiny, stats, tools, utils
- **Suggests** (optional): bslib, callr, DT, jsonlite, knitr, plotly, quarto,
  rmarkdown, roxygen2, testthat

## Coding Style

- Internal helper functions use trailing underscore: `dollar_format_()`,
  `eval_g_function_()`, `latex_escape_text_()`.
- Exported functions use snake_case: `fit_earth()`, `plot_contribution()`.
- Shiny reactive values live in `rv` (a `reactiveValues` list).
- CSS classes use `eui-` prefix: `eui-matrix-header`, `eui-matrix-rowlabel`.

## Common Pitfalls

- `varmod.method != "none"` requires `nfold > 1` and `ncross > 1` in earth.
- When inserting roxygen blocks, ensure you don't displace the block of the
  function below (this has caused lost exports).
- macOS temp paths involve `/var` → `/private/var` symlinks; use
  `normalizePath()` when creating temp dirs for Quarto rendering.
- Kill port 7878 before relaunching: `lsof -ti:7878 | xargs kill`.
