---
title: "Earth Model Report"
format:
  html:
    toc: true
    theme: flatly
    embed-resources: true
    mainfont: "Roboto Condensed"
    include-in-header:
      text: |
        <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
        <style>body { font-family: 'Roboto Condensed', sans-serif; }</style>
  pdf:
    toc: true
    mainfont: "Roboto Condensed"
    sansfont: "Roboto Condensed"
  docx:
    toc: true
    mainfont: "Roboto Condensed"
params:
  result_file: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(earthui)
library(ggplot2)

# Load Roboto Condensed for plots in reports
if (requireNamespace("sysfonts", quietly = TRUE) &&
    requireNamespace("showtext", quietly = TRUE)) {
  sysfonts::font_add_google("Roboto Condensed", "Roboto Condensed")
  showtext::showtext_auto()
}
theme_set(theme_minimal(base_family = "Roboto Condensed"))

result <- readRDS(params$result_file)
summary_info <- format_summary(result)
```

## Dataset Description

| Property | Value |
|----------|-------|
| Observations | `r summary_info$n_obs` |
| Target variable | `r result$target` |
| Predictors used | `r paste(result$predictors, collapse = ", ")` |
| Categorical predictors | `r if (length(result$categoricals) > 0) paste(result$categoricals, collapse = ", ") else "None"` |

## Model Specification

| Parameter | Value |
|-----------|-------|
| Degree | `r result$degree` |
| Cross-validation | `r if (result$cv_enabled) "Yes (10-fold)" else "No"` |
| Number of terms | `r summary_info$n_terms` |
| Predictors in model | `r summary_info$n_predictors` |

## Results Summary

| Metric | Value |
|--------|-------|
| R² | `r sprintf("%.4f", summary_info$r_squared)` |
| GRSq | `r sprintf("%.4f", summary_info$grsq)` |
| GCV | `r sprintf("%.4f", summary_info$gcv)` |
| RSS | `r sprintf("%.2f", summary_info$rss)` |
`r if (result$cv_enabled && !is.na(summary_info$cv_rsq)) paste0("| CV R² | ", sprintf("%.4f", summary_info$cv_rsq), " |")`

## Model Equation

```{r model-equation, results='asis'}
eq <- format_model_equation(result)
cat("$$\n", eq$latex, "\n$$\n")
```

## Coefficients & Basis Functions

```{r coefficients}
knitr::kable(summary_info$coefficients, digits = 4)
```

## Variable Importance

```{r importance-plot, fig.width=8, fig.height=5}
plot_variable_importance(result)
```

```{r importance-table}
knitr::kable(format_variable_importance(result), digits = 4)
```

## g-Function Contributions

```{r g-functions, fig.width=8, fig.height=6, results='asis'}
gf <- list_g_functions(result)

for (i in seq_len(nrow(gf))) {
  label <- gf$label[i]
  if (gf$d[i] >= 2) label <- gsub(" ", " \u00d7 ", label)
  cat(sprintf("\n### %s\n\n", label))

  if (gf$d[i] >= 2) {
    # 3D perspective view
    plot_g_persp(result, i)
    cat("\n\n")
    # Contour map below
    p <- plot_g_contour(result, i)
    print(p)
  } else {
    p <- plot_g_contour(result, i)
    print(p)
  }
  cat("\n\n")
}
```

## Correlation Matrix

```{r correlation-matrix, fig.width=10, fig.height=8}
plot_correlation_matrix(result)
```

## Diagnostics

### Residuals vs Fitted

```{r residuals, fig.width=8, fig.height=5}
plot_residuals(result)
```

### Normal Q-Q Plot

```{r qq, fig.width=8, fig.height=5}
plot_qq(result)
```

### Actual vs Predicted

```{r actual-vs-predicted, fig.width=8, fig.height=5}
plot_actual_vs_predicted(result)
```

## ANOVA Decomposition

```{r anova}
knitr::kable(format_anova(result), digits = 4)
```

## Earth Output

```{r earth-output, comment=""}
model <- result$model
cat("== Model ==\n\n")
print(model)
cat("\n\n== Summary ==\n\n")
print(summary(model))
if (!is.null(model$varmod)) {
  cat("\n\n== Variance Model ==\n\n")
  print(model$varmod)
}
```

---

*Report generated by [earthui](https://github.com/wcraytor/earthui) on `r Sys.time()`*
